tinymce.PluginManager.add('filemanager', function (editor, url) {


    var openDialog = function () {
        let filemanagerPath = editor.settings.filemanager_path;
        if (filemanagerPath.indexOf('callback=') == -1) {
            const parameterSeparator = url.indexOf('?') == -1 ? '?' : '&';
            filemanagerPath += (parameterSeparator + 'multichoice=true&callback=tinyMCEHelper.onSelectedFilesChoose');
        }
        
        tinyMCEHelper.filePickerDialog = editor.windowManager.openUrl({
            title: 'filemanager plugin',
            url: filemanagerPath,
            width: 1024,
            height: 560
        });
    };    

    // Add a button that opens a window
    editor.ui.registry.addButton('filemanager', {
        icon: 'browse',
        text: 'File Manager',
        onAction: function () {
            openDialog();
        }
    });

    // Adds a menu item, which can then be included in any menu via the menu/menubar configuration
    editor.ui.registry.addMenuItem('filemanager', {
        text: 'filemanager plugin',
        onAction: function () {
            openDialog();
        }
    });
});